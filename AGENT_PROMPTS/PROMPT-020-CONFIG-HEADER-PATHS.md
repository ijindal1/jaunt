# PROMPT-020: Config + Header + Path Mapping (L1)

Repo: `/Users/ishitajindal/Documents/jaunt`

## Depends On
- `PROMPT-010A` (`jaunt.errors`)

## Objective
Implement:
- `jaunt.toml` project root discovery + config loading/validation
- generated file header format + parse helpers
- pure module↔path mapping helpers

All functions in this prompt should be deterministic and unit-testable.

## Owned Files (avoid editing anything else)
- `src/jaunt/config.py`
- `src/jaunt/header.py`
- `src/jaunt/paths.py`
- `tests/test_config.py`
- `tests/test_header.py`
- `tests/test_paths.py`

## Deliverables

### `src/jaunt/config.py`
Implement:
- `find_project_root(start: Path) -> Path`
  - Walk upward from `start` (file or directory) looking for `jaunt.toml`.
  - If none found: raise `JauntConfigError` mentioning `jaunt.toml`.

- Dataclasses:
  - `PathsConfig(source_roots: list[str], test_roots: list[str], generated_dir: str)`
  - `LLMConfig(provider: str, model: str, api_key_env: str)`
  - `BuildConfig(jobs: int, infer_deps: bool)`
  - `TestConfig(jobs: int, infer_deps: bool, pytest_args: list[str])`
  - `PromptsConfig(build_system: str, build_module: str, test_system: str, test_module: str)`
  - `JauntConfig(version: int, paths: PathsConfig, llm: LLMConfig, build: BuildConfig, test: TestConfig, prompts: PromptsConfig)`

- `load_config(*, root: Path | None = None, config_path: Path | None = None) -> JauntConfig`
  - Defaults (match `TASK-000-MVP-PLAN.md`):
    - `paths.source_roots = ["src", "."]`
    - `paths.test_roots = ["tests"]`
    - `paths.generated_dir = "__generated__"`
    - `llm.provider = "openai"`
    - `llm.model = "gpt-5.2"`
    - `llm.api_key_env = "OPENAI_API_KEY"`
    - `build.jobs = 8`, `build.infer_deps = true`
    - `test.jobs = 4`, `test.infer_deps = true`, `test.pytest_args = ["-q"]`
    - `prompts.* = ""` (meaning: use packaged defaults)
  - Validation:
    - at least one `source_root` exists on disk (relative to `root`)
    - `generated_dir` is a valid Python identifier
    - `jobs >= 1`
  - Raise `JauntConfigError` for missing/invalid config.

Note: keep I/O minimal: only read TOML + existence checks. No discovery scanning here.

### `src/jaunt/header.py`
Implement:
- `format_header(*, tool_version: str, kind: Literal["build","test"], source_module: str, module_digest: str, spec_refs: list[str]) -> str`
  - Must emit exactly comment lines per MVP spec:
    - `# This file was generated by jaunt. DO NOT EDIT.`
    - `# jaunt:tool_version=...`
    - `# jaunt:kind=build|test`
    - `# jaunt:source_module=...`
    - `# jaunt:module_digest=sha256:<hex>`
    - `# jaunt:spec_refs=<json-array>`
- `parse_header(source: str) -> dict[str, str] | None`
  - Return None if the file does not start with the Jaunt header marker.
  - Parse only from the start; tolerate trailing code.
- `extract_module_digest(source: str) -> str | None`

### `src/jaunt/paths.py`
Pure helpers (no writes):
- `spec_module_to_generated_module(module: str, generated_dir: str = "__generated__") -> str`
  - Example: `my_project.foo` → `my_project.__generated__.foo`
  - Package init module example: `my_project` → `my_project.__generated__`
- `module_to_relpath(module: str) -> Path`
  - `my_project.foo` → `my_project/foo.py`
  - `my_project` → `my_project/__init__.py`
- `generated_module_to_relpath(module: str) -> Path`
  - `my_project.__generated__.foo` → `my_project/__generated__/foo.py`
  - `my_project.__generated__` → `my_project/__generated__/__init__.py`

## Tests

### `tests/test_config.py`
Cover:
- minimal config `version = 1` loads and defaults apply
- custom overrides work
- invalid TOML raises `JauntConfigError`
- missing config raises `JauntConfigError`
- `find_project_root` success and failure cases
- validation: bad generated_dir (non-identifier) raises

### `tests/test_header.py`
Use the TDD plan tests (roundtrip parse, comment lines, extract digest) but align with the exact header format above.

### `tests/test_paths.py`
Cover:
- `my_project` maps to `my_project/__init__.py` and generated `my_project/__generated__/__init__.py`
- `my_project.sub.mod` maps correctly to generated relpath

## Quality Gates
```bash
.venv/bin/python -m pytest -q tests/test_config.py tests/test_header.py tests/test_paths.py
.venv/bin/python -m ruff check src tests
.venv/bin/python -m ty check
```

## Constraints
- No network calls.
- Keep config schema aligned with `TASK-000` (don’t add random knobs unless required by later tasks).

